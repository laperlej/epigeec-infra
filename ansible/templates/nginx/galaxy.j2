upstream galaxy {
	server {{ galaxy_config.gravity.gunicorn.bind }};

	# Or if you serve galaxy at a path like http(s)://fqdn/galaxy
	# Remember to set galaxy_url_prefix in the galaxy.yml file.
	# server {{ galaxy_config.gravity.gunicorn.bind }}:/galaxy;
}

server {
	# Listen on port 443
	listen        *:443 ssl default_server;
	# The virtualhost is our domain name
	server_name   "{{ inventory_hostname }}";

	# Our log files will go to journalctl
	access_log  syslog:server=unix:/dev/log;
	error_log   syslog:server=unix:/dev/log;

	# The most important location block, by default all requests are sent to gunicorn
	# If you serve galaxy at a path like /galaxy, change that below (and all other locations!)
	location /galaxy {
		# This is the backend to send the requests to.
		proxy_pass http://galaxy;

		proxy_set_header Host $http_host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Upgrade $http_upgrade;

		proxy_connect_timeout       600;
        proxy_send_timeout          600;
        proxy_read_timeout          600;
        send_timeout                600;
	}

	# Static files can be more efficiently served by Nginx. Why send the
	# request to Gunicorn which should be spending its time doing more useful
	# things like serving Galaxy!
	location /static {
		alias {{ galaxy_server_dir }}/static;
		expires 24h;
	}

    #
	# Point to the UseGalaxy.ca Welcome page
	#
	location /static/welcome.html {
	    proxy_pass {{ galaxy_public_page_url }};
		expires 24h;
	}

	# serve visualization and interactive environment plugin static content
	location ~ ^/plugins/(?<plug_type>[^/]+?)/((?<vis_d>[^/_]*)_?)?(?<vis_name>[^/]*?)/static/(?<static_file>.*?)$ {
		alias {{ galaxy_server_dir }}/config/plugins/$plug_type/;
		try_files $vis_d/${vis_d}_${vis_name}/static/$static_file
		          $vis_d/static/$static_file =404;
	}

	location /robots.txt {
		alias {{ galaxy_server_dir }}/static/robots.txt;
	}

	location /favicon.ico {
		alias {{ galaxy_server_dir }}/static/favicon.ico;
	}

	location /_x_accel_redirect {
		internal;
		alias /;
	}

	# Support click-to-run in the GTN-in-Galaxy Webhook
    # https://docs.galaxyproject.org/en/master/admin/special_topics/gtn.html
	location /training-material/ {
		proxy_pass https://training.galaxyproject.org/training-material/;
	}
}
